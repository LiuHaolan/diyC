<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Networking - Linux containers from scratch - diyC</title>
        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <link href="../extra.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="..">Linux containers from scratch - diyC</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="..">Home</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Building containers <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../namespaces/">Linux Namespaces</a>
</li>
                                    
<li >
    <a href="../cgroups/">Linux Cgroups</a>
</li>
                                    
<li class="active">
    <a href="./">Networking</a>
</li>
                                    
<li >
    <a href="../images-containers/">Images and containers</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">diyC <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../diyc/install/">Installation</a>
</li>
                                    
<li >
    <a href="../diyc/usage/">Running containers</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../cgroups/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../images-containers/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/w-vi/diyC/edit/master/docs/networking.md"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#containers-and-networking">Containers and networking</a></li>
            <li><a href="#virtual-ethernet-devices">Virtual Ethernet devices</a></li>
            <li><a href="#connecting-containers-using-bridge">Connecting containers using bridge</a></li>
            <li><a href="#iptables">iptables</a></li>
            <li><a href="#more-to-read">More to read</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="containers-and-networking">Containers and networking<a class="headerlink" href="#containers-and-networking" title="Permanent link">#</a></h1>
<p>Containers without network access are in many cases pretty useless. If
the container should not share network resources with the host that is
has it's own network namespace we need to connect it somehow because
by default new network namespace has only loop device, you can add the
network device to a namespace but it can reside only in one of them.
Considering dozens of containers on a single host we are not going to
have enough physical interfaces.</p>
<h2 id="virtual-ethernet-devices">Virtual Ethernet devices<a class="headerlink" href="#virtual-ethernet-devices" title="Permanent link">#</a></h2>
<p>In Linux you can create virtual Ethernet devices, they come in pairs,
a so called veth pair, which you can think of as two Ethernet cards
connected by a cable. using ip tool you can easily assign one of the
pair to the container's namespace and the other somewhere
else. Ideally
to <a href="https://wiki.linuxfoundation.org/networking/bridge">Linux bridge</a>
or <a href="http://openvswitch.org/">Open vSwitch</a> so we can create virtual
networks.</p>
<h2 id="connecting-containers-using-bridge">Connecting containers using bridge<a class="headerlink" href="#connecting-containers-using-bridge" title="Permanent link">#</a></h2>
<p>Using the Linux bridge is the easiest, we create
the bridge which we call here <code>diyc0</code> and assign it IPv4 address <code>172.16.0.1/24</code>.</p>
<pre><code class="bash"># Create the bridge
$ ip link add name diyc0 type bridge
# Assign it IPv4
$ ip addr add dev diyc0 172.16.0.1/24
$ ip link set diyc0 up
</code></pre>

<p>Before we run the container we connect the created <code>vethXYZ</code> device to the
bridge that's the host half of the pair. The other one is later added
to the network namespace of the container, effectively connecting the
two namespace.</p>
<pre><code class="bash"># Create the veth pair
$ ip link add vethXYZ type veth peer name veth1
# Connect the host half to bridge
$ ip link set vethXYZ master diyc0
# Add the veth1 to the container's network namespace
# &lt;PID&gt; is pid of the container process
$ ip link set veth1 netns &lt;PID&gt;
</code></pre>

<p><em>Below: Connecting containers using veth pairs and Linux bridge</em>
<img alt="veth Bridge" src="../img/veth-bridge.png" /></p>
<div class="admonition seealso">
<p class="admonition-title">Code</p>
<p>Code in diyC uses <code>system()</code> function to shell out so you can
easily replicate it on the command line.<br />
<a href="https://github.com/w-vi/diyC/blob/master/src/diyc.c#L241-L278">diyc.c:241-278</a></p>
</div>
<h2 id="iptables">iptables<a class="headerlink" href="#iptables" title="Permanent link">#</a></h2>
<p>Once the containers are hooked up using veth pairs and a bridge it
comes to iptables to do NAT and routing to allow containers to connect
to the outer world. See the <code>net-setup</code> code in the
<a href="https://github.com/w-vi/diyC/blob/master/Makefile#L28-L37">Makefile</a>
to inspect the exact rules. Basically setup NAT and forwarding on the container
network in our case <code>172.16.0.0/16</code>.</p>
<h2 id="more-to-read">More to read<a class="headerlink" href="#more-to-read" title="Permanent link">#</a></h2>
<ul>
<li><a href="http://www.opencloudblog.com/?p=66">Linux Switching â€“ Interconnecting Namespaces</a></li>
<li><a href="http://www.opencloudblog.com/?p=42">Linux Network Namespaces</a></li>
</ul></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
