<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">

	<title>Running containers - Linux containers from scratch - diyC</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../css/base.css" rel="stylesheet">
        <link href="../../extra.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="../..">Linux containers from scratch - diyC</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="../..">Home</a>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Building containers <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        
<li >
    <a href="../../namespaces/">Linux Namespaces</a>
</li>

                    
                        
<li >
    <a href="../../cgroups/">Linux Cgroups</a>
</li>

                    
                        
<li >
    <a href="../../networking/">Networking</a>
</li>

                    
                        
<li >
    <a href="../../images-containers/">Images and containers</a>
</li>

                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">diyC <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        
<li >
    <a href="../install/">Installation</a>
</li>

                    
                        
<li class="active">
    <a href="./">Running containers</a>
</li>

                    
                    </ul>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                <li >
                    <a rel="next" href="../install/">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li class="disabled">
                    <a rel="prev" >
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
                <li>
                    <a href="https://github.com/w-vi/diyC">
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#usage">Usage</a></li>
        
            <li><a href="#example-get-a-container-running">Example: Get a container running</a></li>
        
            <li><a href="#example-network-between-two-containers">Example: Network between two containers</a></li>
        
            <li><a href="#example-limit-memory-used-by-cgroups">Example: Limit memory used by cgroups</a></li>
        
            <li><a href="#removing-exited-containers">Removing exited containers</a></li>
        
            <li><a href="#removing-the-diyc0-bridge-and-iptables-rules">Removing the diyc0 bridge and iptables rules</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h1 id="usage">Usage<a class="headerlink" href="#usage" title="Permanent link">#</a></h1>
<pre><code class="bash">    diyc [hv][-m NUMBER] [-ip IPV4 ADDRESS] &lt;NAME&gt; &lt;IMAGE&gt; &lt;CMD&gt;

    -h, --help           print the help

    -i, --ip             ip address of the container, if not set then host
                         network is used. It must be in the 172.16.0/16 network
                         as the bridge diyc0 is 172.16.0.1

    -m, --mem            maximum size of the memory in MB allowed for the container
                         by default there no explicit limit defined.

    -v, --verbose        more verbose output

    &lt;NAME&gt;               name of the container, needs to be unique

    &lt;IMAGE&gt;              image to be used for the container, must be a directory name
                         under the images directory

    &lt;CMD&gt;                command to be executed inside the container
</code></pre>

<h2 id="example-get-a-container-running">Example: Get a container running<a class="headerlink" href="#example-get-a-container-running" title="Permanent link">#</a></h2>
<p>This is an example session showing how to get a container with minimal
debian based system up and running from zero.</p>
<pre><code class="bash">$ git clone git@github.com:w-vi/diyc.git
Cloning into 'diyc'...
remote: Counting objects: 9, done.
remote: Compressing objects: 100% (8/8), done.
remote: Total 9 (delta 1), reused 9 (delta 1), pack-reused 0
Receiving objects: 100% (9/9), 12.95 KiB | 0 bytes/s, done.
Resolving deltas: 100% (1/1), done.

$ cd diyc

$ make setup
sudo iptables -A FORWARD -i enp5s0 -o veth -j ACCEPT || true
sudo iptables -A FORWARD -o enp5s0 -i veth -j ACCEPT || true
sudo iptables -t nat -A POSTROUTING -s 172.16.0.0/16 -j MASQUERADE || true
sudo ip link add name diyc0 type bridge || true
sudo ip addr add dev diyc0 172.16.0.1/24 || true
sudo ip link set diyc0 up || true
sudo iptables -A FORWARD -i enp5s0 -o diyc0 -j ACCEPT || true
sudo iptables -A FORWARD -o enp5s0 -i diyc0 -j ACCEPT || true
sudo iptables -A FORWARD -o diyc0 -i diyc0 -j ACCEPT || true
mkdir -p containers
mkdir -p images

$ make
gcc -std=c99 -Wall -Werror -O2 src/diyc.c -o diyc
gcc -std=c99 -Wall -Werror -O2 src/nsexec.c -o nsexec

$ docker pull debian
Using default tag: latest
latest: Pulling from library/debian
Digest: sha256:72f784399fd2719b4cb4e16ef8e369a39dc67f53d978cd3e2e7bf4e502c7b793
Status: Image is up to date for debian:latest

$ docker run -ti debian /bin/bash

$ docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
2c924241399c        debian              &quot;/bin/bash&quot;         21 seconds ago      Up 20 seconds                           epic_leavitt

$ docker export 2c924241399c &gt;! debian.tar

$ mkdir images/debian

$ tar -xf debian.tar -C images/debian/

$ sudo ./diyc my1 debian bash

  root@my1:/&gt; exit
  exit
</code></pre>

<h2 id="example-network-between-two-containers">Example: Network between two containers<a class="headerlink" href="#example-network-between-two-containers" title="Permanent link">#</a></h2>
<p>Spin up two different containers with different IPs. In this case it
they are based on debian so Python and curl need to be installed
first.</p>
<pre><code class="bash">$ sudo ./diyc -i 172.16.0.30 server debian bash
root@server:/&gt; apt-get update &amp;&amp; apt-get install python
root@server:/&gt; python -m SimpleHTTPServer
Serving HTTP on 0.0.0.0 port 8000 ...

$ sudo ./diyc -i 172.16.0.31 client debian bash
root@client:/&gt; apt-get update &amp;&amp; apt-get install curl
root@client:/&gt; curl http://172.16.0.30:8000

# it is accessible from the host too
$ curl http://172.16.0.30:8000
</code></pre>

<h2 id="example-limit-memory-used-by-cgroups">Example: Limit memory used by cgroups<a class="headerlink" href="#example-limit-memory-used-by-cgroups" title="Permanent link">#</a></h2>
<p>Having an image with python or perl installed you can easily see the
OOM killer in action. We will allow only 10 MB of memory.</p>
<pre><code class="bash">$ sudo ./diyc -m 10 cgroup debian bash
root@cgroup:/&gt; python -c 'str = &quot; &quot; * 100000'
root@cgroup:/&gt; python -c 'str = &quot; &quot; * 1000000'
root@cgroup:/&gt; python -c 'str = &quot; &quot; * 10000000'
Killed
</code></pre>

<h2 id="removing-exited-containers">Removing exited containers<a class="headerlink" href="#removing-exited-containers" title="Permanent link">#</a></h2>
<p>Because containers after exit leave their filesystem behind and it is
not destroyed you can run it again. The data are stored in the
<code>containers/&lt;name&gt;/</code> directory so as long as this directory exists you
can start and stop the container. To remove it just <code>sudo rm -rf
containers/&lt;name&gt;</code>.</p>
<h2 id="removing-the-diyc0-bridge-and-iptables-rules">Removing the diyc0 bridge and iptables rules<a class="headerlink" href="#removing-the-diyc0-bridge-and-iptables-rules" title="Permanent link">#</a></h2>
<p>Just run <code>make net-clean</code>.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            
            <center>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</center>
        </footer>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script>var base_url = '../..';</script>
        <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
        <script src="../../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>