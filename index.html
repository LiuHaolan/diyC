<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="./img/favicon.ico">

	<title>Linux containers from scratch - diyC</title>

        <link href="./css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="./css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="./css/highlight.css">
        <link href="./css/base.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href=".">Linux containers from scratch - diyC</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li class="active">
                    <a href=".">Home</a>
                </li>
            
            
            
                <li >
                    <a href="usage/">Usage</a>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                <li class="disabled">
                    <a rel="next" >
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="usage/">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
                <li>
                    <a href="https://github.com/w-vi/diyc">
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#linux-containers-from-scratch-diyc">Linux containers from scratch - diyC</a></li>
        
            <li><a href="#what-is-diyc">What is diyC</a></li>
        
            <li><a href="#important-note">Important note</a></li>
        
            <li><a href="#prerequisites">Prerequisites</a></li>
        
            <li><a href="#installation">Installation</a></li>
        
            <li><a href="#nsexec">nsexec</a></li>
        
            <li><a href="#preparing-images">Preparing images</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h1 id="linux-containers-from-scratch-diyc">Linux containers from scratch - diyC<a class="headerlink" href="#linux-containers-from-scratch-diyc" title="Permanent link">#</a></h1>
<p>Linux containers exist for a while and are now a mainstream
topic. This is an introduction on how their are created and what they
actually are made of. If you want to see the code then head directly
to <a href="https://github.com/w-vi/diyc">the github repo</a> otherwise read on
the topic you are interested in.</p>
<p><em>Note</em>: Any suggestions or comments are welcome please don't hesitate
and <a href="https://github.com/w-vi/diyc/issues/new">file an issue on github</a>.</p>
<h2 id="what-is-diyc">What is diyC<a class="headerlink" href="#what-is-diyc" title="Permanent link">#</a></h2>
<p>It is a simple educational Linux container runtime. It is
intentionally simple and leaves a lot of stuff out. It is a single C
file of roughly 500 lines including comments showing the core features
of the Linux used to build containers. It includes also the creation
of a container from an image to clarify how images and containers are
related.</p>
<h2 id="important-note">Important note<a class="headerlink" href="#important-note" title="Permanent link">#</a></h2>
<p>It plays with iptables to get the routing and isolation running so if
you have your own iptables rules make sure to save them before doing
anything else <code>sudo iptables-save</code> and <code>sudo iptables-restore</code> to
recover them in case something goes awry.</p>
<h2 id="prerequisites">Prerequisites<a class="headerlink" href="#prerequisites" title="Permanent link">#</a></h2>
<p>This is a educational piece of software and has not been tested on
many systems yet, to give it a go make sure you have the following:</p>
<ul>
<li>recent Linux kernel supporting needed namespaces and cgroups</li>
<li>overlayfs </li>
<li>ip tool (iproute2 package)</li>
<li>iptables</li>
<li>gcc</li>
<li>make</li>
<li>bash</li>
</ul>
<p>Apart from overlayfs most of the distros are prepared and ready, if
not please consult your distro package manager. Overlayfs is in the
mainline kernel so it should be straightforward. It was merged in
version 3.18 but has been improved a lot so you should aim for kernel
4.x.</p>
<p><em>Note</em>: Kernel needs to be configured to support following namespaces
PID, mount, network and UTS, cgroups are needed as well. Most of the
GNU/Linux distros have this support enabled by default.</p>
<h2 id="installation">Installation<a class="headerlink" href="#installation" title="Permanent link">#</a></h2>
<ol>
<li><code>make setup</code></li>
</ol>
<p>It creates the necessary directory structure as well as prepares the
networking part like iptables rules, bridge (diyc0) and so on. To
remove the networking bits like bridge and iptables rules run <code>make
net-clean</code> which removes them all.</p>
<ol>
<li><code>make</code></li>
</ol>
<p>Builds the runtime.</p>
<ol>
<li>Done</li>
</ol>
<h2 id="nsexec">nsexec<a class="headerlink" href="#nsexec" title="Permanent link">#</a></h2>
<p>The above steps also build a <code>nsexec</code> binary which is is a very
simple program that executes a local (host) command in namespaces. See
<code>nsexec --help</code> to see what namespaces are available. Usage is very
simple <code>sudo ./nsexec -pnu myhost bash</code> will start a new bash in new
pid, network and UTS namespace.</p>
<h2 id="preparing-images">Preparing images<a class="headerlink" href="#preparing-images" title="Permanent link">#</a></h2>
<p>The image import and creation is not present but because images are
just <strong>TARBALLS</strong> there is no need for anything fancy.</p>
<h3 id="creating-the-tarball-using-docker">Creating the tarball using docker<a class="headerlink" href="#creating-the-tarball-using-docker" title="Permanent link">#</a></h3>
<p>Using docker is the most straightforward. <code>docker pull</code> the image you
want, spin it up by <code>docker run -ti &lt;image&gt; &lt;command&gt;</code> and in
different terminal do <code>docker export &lt;container&gt; &gt; myimage.tar</code>. You
have the tarball ready.</p>
<h3 id="installing-image">Installing image<a class="headerlink" href="#installing-image" title="Permanent link">#</a></h3>
<p><code>make setup</code> creates an <code>images</code> subdirectory so <code>mkdir
images/myimage</code> followed by <code>tar -xf myimage.tar -C images/myimage/</code>
should do the trick.</p>
<p>See <a href="usage/">how to run a container</a>.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            
            <center>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</center>
        </footer>

        <script src="./js/jquery-1.10.2.min.js"></script>
        <script src="./js/bootstrap-3.0.3.min.js"></script>
        <script src="./js/highlight.pack.js"></script>
        <script>var base_url = '.';</script>
        <script data-main="./mkdocs/js/search.js" src="./mkdocs/js/require.js"></script>
        <script src="./js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>